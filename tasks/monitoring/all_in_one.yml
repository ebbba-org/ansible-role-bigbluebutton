---
- name: create monitoring directory
  file:
    path: "{{ bbb_monitoring_all_in_one_directory }}"
    state: directory
    mode: '0644'

- name: copy docker files into place
  template:
    src: "monitoring/{{ item }}.j2"
    dest: "{{ bbb_monitoring_all_in_one_directory }}/{{ item }}"
    mode: '0644'
  with_items:
    - bbb_exporter_secrets.env
    - docker-compose.yaml
  notify: restart monitoring container

- name: copy prometheus files into place
  template:
    src: "monitoring/prometheus.yaml.j2"
    dest: "{{ bbb_monitoring_all_in_one_directory }}/prometheus.yaml"
    mode: '0644'
  notify: restart monitoring container
  when: bbb_monitoring_all_in_one_enable | bool and not bbb_monitoring_external | bool

- name: start monitoring
  docker_compose:
    pull: true
    project_src: /root/bbb-monitoring/
  when: bbb_monitoring_all_in_one_enable | bool or bbb_monitoring_external | bool
