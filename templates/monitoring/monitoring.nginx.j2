{% if bbb_monitoring_external %}
location {{ bbb_monitoring_metrics_endpoint }} {
  proxy_pass http://127.0.0.1:{{ bbb_monitoring_external_metrics_port }}/metrics;
{% if bbb_monitoring_use_ip_restriction | bool %}
{% for item in bbb_monitoring_external_ip_list %}
    allow {{ item.address }};
{% endfor %}
    # drop rest of the world
    deny all;
  {% endif %}

  {% if not bbb_monitoring_use_ip_restriction or bbb_monitoring_use_restriction_combination %}
    auth_basic "BigBlueButton Exporter";
    auth_basic_user_file /etc/bigbluebutton/nginx/.htpasswd;
  {% endif %}
  include proxy_params;
}

location {{ bbb_monitoring_node_exporter_endpoint }} {
  proxy_pass http://127.0.0.1:{{ bbb_monitoring_external_node_port }}/;
{% if bbb_monitoring_use_ip_restriction | bool %}
{% for item in bbb_monitoring_external_ip_list %}
    allow {{ item.address }};
{% endfor %}
    # drop rest of the world
    deny all;
  {% endif %}

  {% if not bbb_monitoring_use_ip_restriction or bbb_monitoring_use_restriction_combination %}
    auth_basic "BigBlueButton Exporter";
    auth_basic_user_file /etc/bigbluebutton/nginx/.htpasswd;
  {% endif %}
  include proxy_params;
}
{% else %}
{% set bbb_monitoring_exporter_port = (bbb_monitoring_all_in_one_enable | bool | ternary(bbb_monitoring_all_in_one_port, bbb_monitoring_systemd_port, 9688)) %}
location /monitoring/ {
  proxy_pass http://127.0.0.1:{{ bbb_monitoring_exporter_port }}/;
  include proxy_params;
}
{% endif %}
